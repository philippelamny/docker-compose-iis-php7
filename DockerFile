# escape=`
FROM microsoft/windowsservercore:10.0.14393.2430_fr-fr

# Copy dll for the display of standard out
COPY vcruntime140.dll C:\\Windows\\System32\\vcruntime140.dll

# download servicemonitor  ???
RUN powershell -Command `
    Add-WindowsFeature Web-Server; `
    Invoke-WebRequest -UseBasicParsing -Uri "https://dotnetbinaries.blob.core.windows.net/servicemonitor/2.0.1.3/ServiceMonitor.exe" -OutFile "C:\ServiceMonitor.exe"
	
# Download php 
RUN powershell -Command `	
	[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 ; `
	Invoke-WebRequest -Uri  https://windows.php.net/downloads/releases/php-7.2.10-nts-Win32-VC15-x64.zip  -OutFile php.zip
	
# create Php directory
RUN powershell -Command `
	mkdir C:\php_7.2
	
# Extract downloaded php
RUN powershell -Command `
	Add-Type -AssemblyName System.IO.Compression.FileSystem ; `
	[System.IO.Compression.ZipFile]::ExtractToDirectory('C:\php.zip', 'C:\php_7.2')
	
# Php Ini
RUN powershell -Command `
	cp C:\php_7.2\php.ini-development C:\php_7.2\php.ini

# Set env path for php 
RUN setx /m PATH %PATH%;c:\php_7.2


RUN powershell -Command " `
	Import-module iisadministration ; `
	DISM.EXE /enable-feature /online /featureName:IIS-CGI /all "
		
#COPY applicationhost.config c:\\windows\\system32\\inetsrv\\config\\applicationhost.config

RUN powershell -Command " `
	Get-IISConfigSection -SectionPath system.webServer/defaultDocument | Get-IISConfigCollection -CollectionName files | New-IISConfigCollectionElement -ConfigAttribute @{'Value' = 'index.php'} ; `	
	Get-IISConfigSection system.webServer/fastCgi | Get-IISConfigCollection | New-IISConfigCollectionElement -ConfigAttribute @{'fullPath'='C:\php_7.2\PHP-CGI.EXE';'maxInstances'=0;'instanceMaxRequests'=10000}  ; `
	Get-IISConfigSection system.webServer/fastCgi | Get-IISConfigCollection | Get-IISConfigCollectionElement -ConfigAttribute @{'fullPath'='C:\php_7.2\PHP-CGI.EXE'} | Get-IISConfigElement -ChildElementName environmentVariables | Get-IISConfigCollection | New-IISConfigCollectionElement -ConfigAttribute @{'name'='PHP_FCGI_MAX_REQUESTS';'value'='10000'}  ; `
	Get-IISConfigSection system.webServer/fastCgi | Get-IISConfigCollection | Get-IISConfigCollectionElement -ConfigAttribute @{'fullPath'='C:\php_7.2\PHP-CGI.EXE'} | Get-IISConfigElement -ChildElementName environmentVariables | Get-IISConfigCollection | New-IISConfigCollectionElement -ConfigAttribute @{'name'='PHPRC';'value'='C:\php_7.2'}  ; `
	Get-IISConfigSection system.webServer/handlers | Get-IISConfigCollection | New-IISConfigCollectionElement -ConfigAttribute @{'name'='PHP-iisfcgi';'path'='*.php';'verb'='GET,HEAD,POST';'modules'='FastCgiModule';'scriptProcessor'='C:\php_7.2\PHP-CGI.EXE';'resourceType'='Either';'requireAccess'='Script'} -AddAt 0 "

RUN powershell -Command " `
	Reset-IISServerManager -Confirm:$false "

RUN powershell -Command " `
	Start-Service was ; `
	Start-Service w3svc ; `
	Start-Service was ; `
	get-iissite | Start-IISSite "
	
EXPOSE 80

ENTRYPOINT ["C:\\ServiceMonitor.exe", "w3svc"]

